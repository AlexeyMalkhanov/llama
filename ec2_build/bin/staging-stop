#!/usr/bin/env python
# Copyright (c) 2010 Cloudera, inc.
# https://wiki.cloudera.com/display/PRODUCT/Staging+step

import sys
import os, re
import boto
import subprocess
from optparse import OptionParser
import time
import cloudera.aws.ec2
import cloudera.staging.ElasticIpManager
import cloudera.staging.ArchiveManager
import cloudera.staging.StageManager
from cloudera.utils import display_message


def main():
  usage = "usage: %prog  [options] --instance <Instance id>"
  op = OptionParser(usage=usage)
  op.add_option('-d', '--dry-run',
              action="store_true",
              default=False,
              help="Dont do anything just pretend")

  op.add_option('-i', '--instance',
            help="Instance to stop")

  op.add_option('-a', '--ip-address',
            help="IP address of the Instance to stop")


  (options, args) = op.parse_args()


  if not options.instance and not options.ip_address:
    op.error("I don't know what to delete. Please provide either the instance id or an IP address")

  # EC2 connection
  ec2_connection  = boto.connect_ec2()

  archiveManager = cloudera.staging.ArchiveManager.ArchiveManager(ec2_connection)

  instance = cloudera.aws.ec2.instance_for_instance_id(ec2_connection, options.instance)
  if not instance:
    print "Couldn't find instance"
    sys.exit(-1)

  archiveManager.tear_down_archive(instance)

main()
