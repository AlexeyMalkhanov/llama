#!/usr/bin/python
#
# (c) Copyright 2008 Cloudera, Inc.
#
# Master Targets file for Cloudera Hadoop distribution (CH) system


# List of all distribution editions we compile from this tree.
# This is the default target.
allDistributions = EmptyPackageTarget(
  requiredTargets = [ ":supportedDistro" ])

# Scribe required libraries
libfb303Component = FileComponent(
  srcFile = "scribe-log4j/lib/libfb303.jar",
  destDir = "build/hadoop-0.18.2/src/contrib/scribe-log4j/lib",)

libthriftComponent = FileComponent(
  srcFile = "scribe-log4j/lib/libthrift.jar",
  destDir = "build/hadoop-0.18.2/src/contrib/scribe-log4j/lib",)

libfb303Component2 = FileComponent(
  srcFile = "scribe-log4j/lib/libfb303.jar",
  destDir = "src/contrib/scribe-log4j/lib",)

libthriftComponent2 = FileComponent(
  srcFile = "scribe-log4j/lib/libthrift.jar",
  destDir = "src/contrib/scribe-log4j/lib",)

# remove log4j.properties
log4jpropComponent = ExcludeComponent(
  name = "conf/log4j.properties",)

log4jpropComponent2 = ExcludeComponent(
  name = "build/hadoop-0.18.2/conf/log4j.properties",)

#nn and jt JSP change dependencies
bluebarComponent = FileComponent(
  srcFile = "nn+jt_jsp/static/images/bluebar.png",
  destDir = "build/hadoop-0.18.2/src/webapps/static/images/",)

logoComponent = FileComponent(
  srcFile = "nn+jt_jsp/static/images/logo.png",
  destDir = "build/hadoop-0.18.2/src/webapps/static/images/",)

bluebarComponent2 = FileComponent(
  srcFile = "nn+jt_jsp/static/images/bluebar.png",
  destDir = "src/webapps/static/images/",)

logoComponent2 = FileComponent(
  srcFile = "nn+jt_jsp/static/images/logo.png",
  destDir = "src/webapps/static/images/",)

# Compile a Hadoop redist tarball to put in the distribution

# include the pre-compiled native libs, since we don't build those ourselves
hadoopNativeLibs = DirComponent(
  srcDir  = "native",
  destDir = "build/hadoop-0.18.2/lib/native")

supportedHadoopPackage = HadoopPackageTarget(
  packageName   = "distrib-hadoop",
  baseHadoopDir = "thirdparty/hadoop-0.18.2",
  baseVersion   = "0.18.2",
  patchVersion  = "CH-0.1.0",
  patchPlan     = [
      "projects/HadoopDist/scribe-log4j/scribe_hadoop_trunk_v3.patch",
      "projects/HadoopDist/nn+jt_jsp/nn+jt_cloudera_0.18.2.patch",
                  ],
  components    = [ libfb303Component,
                    libthriftComponent,
                    libfb303Component2,
                    libthriftComponent2,
                    bluebarComponent,
                    logoComponent,
                    bluebarComponent2,
                    logoComponent2,
                    log4jpropComponent,
                    log4jpropComponent2,
                    hadoopNativeLibs
                   ])

# components for packaging

# Hadoop itself!
hadoopComponent = PackageComponent(
  targetName = ":supportedHadoopPackage",
  includeZip = True,
  destDir    = "packages")

# the installation system
installerComponent = PackageComponent(
  targetName = "projects/HadoopDist/installer:release",
  includeZip = False, # we need this unpackacked
  destDir    = "bin")

# take the pig tgz package we assembled in thirdparty/pig/ and include that
# in our distribution package.
pigPackageComponent = PackageComponent(
  targetName = "thirdparty/pig-0.1.1:pigPackage",
  includeZip = True,
  destDir    = "packages")

# take the hive tgz package we assembled in thirdparty/hive/ and include
# this in our distribution package
hivePackageComponent = PackageComponent(
  targetName = "thirdparty/hive-chd-0.1.0:hivePackage",
  includeZip = True,
  destDir    = "packages")

# TODO: documentation component, any other scripts, etc

# There may be several versions of how we package the distribution.
# supportedDistro is the one released to support clients
supportedDistro = PackageTarget(
  packageName = "cloudera-hadoop",
  version     = "0.1.0",
  components  = [
    hadoopComponent,
    installerComponent,
    pigPackageComponent,
    hivePackageComponent
  ])


# subdirectory targets:
#   installer -- guided and noattend python installation system
#   test      -- Cluster Test tool
ProjectList(requiredTargets=[
  "projects/HadoopDist/installer",
  "projects/HadoopDist/test"
  ])


defaultTarget(allDistributions)

