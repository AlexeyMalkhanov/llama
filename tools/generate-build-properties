#!/bin/bash -x
# Copyright (c) 2009, Cloudera, inc
#
# Generates a build.properties file which can be fed to ant's
# -propertyfile argument in order to set the build version,
# git hash, etc.

set -e
TOOLS_DIR=$(readlink -f $(dirname $0))

if [ $# -ne 12 ]; then
  echo usage: $0 git_repo base_branch build_branch out-file version pkg-version pkg-release pkg-name cdh-release component-hase packaging-hash cdh-hash
  exit 1
fi

# Args
GIT_REPO=$1
BASE_BRANCH=$2
BUILD_BRANCH=$3
OUT=$4
VERSION=$5
PKG_VERSION=$6
PKG_RELEASE=$7
PKG_NAME=$8
CDH_REL=$9
COMPONENT_HASH=${10}
PACKAGING_HASH=${11}
CDH_HASH=${12}

DATETIME=`date -u "+%Y.%m.%d-%H:%M:%SGMT"`

echo "
# Autogenerated build properties
version=$VERSION
git.hash=$COMPONENT_HASH
cloudera.hash=$COMPONENT_HASH
cloudera.cdh.hash=$CDH_HASH
cloudera.cdh-packaging.hash=$PACKAGING_HASH
cloudera.base-branch=$BASE_BRANCH
cloudera.build-branch=$BUILD_BRANCH
cloudera.pkg.version=$PKG_VERSION
cloudera.pkg.release=$PKG_RELEASE
cloudera.pkg.name=$PKG_NAME
cloudera.cdh.release=$CDH_REL
cloudera.build.time=$DATETIME
" > $OUT

CLOUDERA_DIR=$(readlink -f $(dirname $OUT))

cp -f $OUT $CLOUDERA_DIR/cdh_version.properties
