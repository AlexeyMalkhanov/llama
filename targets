#!/usr/bin/python
#
# (c) Copyright 2009 Cloudera, Inc.
#
# Master Targets file for Cloudera Hadoop distribution (CH) system

# Set some version constants which appear throughout this project.

# Version of Hadoop our system is based on:
# RPM release number
rpm_release="1.cloudera"

# Hadoop
base_hadoop_ver = "0.20.0"

hadoop_ver_string = "hadoop-" + base_hadoop_ver
RegisterProperty('hadoop.repo', '%(srcdir)/repos/hadoop')
RegisterProperty('hadoop.base.version', base_hadoop_ver)
RegisterProperty('hadoop.rpm.release', rpm_release)
RegisterProperty('hadoop.base.ref', 'apache/tags/release-%s' % base_hadoop_ver)
RegisterProperty('hadoop.build.ref', 'cdh-0.20')
RegisterProperty('hadoop.pristine.tarball',
                 '%%(srcdir)/repos/pristine/%s.tar.gz' % hadoop_ver_string)

# Pig
base_pig_ver="0.2.0"
pig_ver_string="pig-" + base_pig_ver

RegisterProperty('pig.base.version', base_pig_ver)
RegisterProperty('pig.repo', '%(srcdir)/repos/pig')
RegisterProperty('pig.base.ref', 'apache/tags/release-%s' % base_pig_ver)
RegisterProperty('pig.build.ref', 'cdh-0.18')
RegisterProperty('pig.rpm.release', '1.cloudera.CH0_3')
RegisterProperty('pig.pristine.tarball',
                 '%%(srcdir)/repos/pristine/%s.tar.gz' % pig_ver_string)


# Hive
base_hive_ver="0.3.0"
hive_ver_string="hive-" + base_hive_ver

RegisterProperty('hive.base.version', base_hive_ver)
RegisterProperty('hive.repo', '%(srcdir)/repos/hive')
RegisterProperty('hive.base.ref', 'apache/tags/release-%s' % base_hive_ver)
RegisterProperty('hive.build.ref', 'cdh-0.18')
RegisterProperty('hive.rpm.release', '4.cloudera.CH0_3')
RegisterProperty('hive.pristine.tarball',
                 '%(srcdir)/repos/pristine/hive-0.3.0-hadoop-0.18.0-dev.tar.gz')

hadoop_cloudera_ver_string = "hadoop-%s-%s" % (base_hadoop_ver, rpm_release)


supportedHadoopPackage = PackageTarget(
  package_name = hadoop_cloudera_ver_string,
  clean_first=True,
  steps = [
    cloudera.SetupBuildStep("hadoop"),
  # Apply patches
    Exec(
      executable="%(assemblydir)/cloudera/apply-patches",
      arguments=["%(assemblydir)/",
                 "%(assemblydir)/cloudera/patches"]),
  # Build, baby, build
    AntCall(
      properties = {'version': '%s-%s' % (base_hadoop_ver, rpm_release),
                    'libhdfs': 'true',
                    'compile.native': 'true',
                    'compile.c++': 'true'},
      
      ant_target = "bin-package"),
    Tar(
      filename = hadoop_cloudera_ver_string + ".tar.gz",
      dir = "build/%s" % (hadoop_cloudera_ver_string)
      ),
  ])

# subdirectory targets:
ProjectList(required_targets=[
  "repos/hadoop-package/:rpm",
  "repos/hadoop-package/:deb",
  "repos/hive-package/:rpm",
  "repos/hive-package/:deb",
  "repos/pig-package/:rpm",
  "repos/pig-package/:deb",
  ":supportedHadoopPackage",
  ])
