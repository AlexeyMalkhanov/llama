#!/usr/bin/python
#
# (c) Copyright 2009 Cloudera, Inc.
#
# Master Targets file for Cloudera Hadoop distribution (CH) system

# Set some version constants which appear throughout this project.

# Version of Hadoop our system is based on:
base_hadoop_ver = "0.18.3"
hadoop_ver_string = "hadoop-" + base_hadoop_ver

# Cloudera Hadoop dist version.
base_ch_ver = "0.3.0"

# RPM release number
rpm_release="12.cloudera.CH0_3"

# pig version
base_pig_ver="0.2.0"
pig_ver_string="pig-" + base_pig_ver

RegisterProperty('projects.HadoopDist.base_ch_ver', base_ch_ver)
RegisterProperty('projects.HadoopDist.release', rpm_release)
RegisterProperty('projects.HadoopDist.base_hadoop_ver', base_hadoop_ver)
RegisterProperty('projects.HadoopDist.base_pig_ver', base_pig_ver)

# Hadoop
RegisterProperty('hadoop.repo', '%(srcdir)/repos/hadoop')
RegisterProperty('hadoop.base.ref', 'apache/tags/release-%s' % base_hadoop_ver)
RegisterProperty('hadoop.build.ref', 'cdh-0.18')
RegisterProperty('hadoop.pristine.tarball',
                 '%%(srcdir)/repos/pristine/%s.tar.gz' % hadoop_ver_string)

# Pig
RegisterProperty('pig.version', base_pig_ver)
RegisterProperty('pig.repo', '%(srcdir)/repos/pig')
RegisterProperty('pig.base.ref', 'apache/tags/release-%s' % base_pig_ver)
RegisterProperty('pig.build.ref', 'cdh-0.18')
RegisterProperty('pig.pristine.tarball',
                 '%%(srcdir)/repos/pristine/%s.tar.gz' % pig_ver_string)


hadoop_cloudera_ver_string = "hadoop-%s-%s" % (base_hadoop_ver, rpm_release)



supportedHadoopPackage = PackageTarget(
  package_name = hadoop_cloudera_ver_string,
  clean_first=True,
  steps = [
  # Set up the build tree
    Exec(
      executable="//tools/setup-package-build",
      arguments=["${hadoop.repo}",
                 "${hadoop.base.ref}",
                 "${hadoop.build.ref}",
                 "${hadoop.pristine.tarball}",
                 "%(assemblydir)/"],
      inputs=["${hadoop.repo}/"],
      ),
  # Apply patches
    Exec(
      executable="%(assemblydir)/cloudera/apply-patches",
      arguments=["%(assemblydir)/",
                 "%(assemblydir)/cloudera/patches"]),
  # Build, baby, build
    AntCall(
      properties = {'version': '%s-%s' % (base_hadoop_ver, rpm_release),
                    'libhdfs': 'true',
                    'compile.native': 'true',
                    'compile.c++': 'true'},
      ant_target = "package"),
    Tar(
      filename = hadoop_cloudera_ver_string + ".tar.gz",
      dir = "build/%s" % (hadoop_cloudera_ver_string)
      ),
  ])

# subdirectory targets:
ProjectList(required_targets=[
  "repos/hadoop-package/rpm",
  "repos/hadoop-package/deb",
  "repos/hive-package/rpm",
  "repos/hive-package/deb",
  "repos/pig-package/rpm",
  "repos/pig-package/deb",
  ":supportedHadoopPackage",
  ])
